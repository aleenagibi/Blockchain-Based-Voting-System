<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üáÆüá≥ Admin Dashboard - Indian Blockchain Voting</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container py-5">
    <div class="hero-section">
      <h1 class="hero-title text-center mb-4">
        <i class="fas fa-user-shield"></i> 
        üáÆüá≥ Admin Dashboard
      </h1>
      <p class="hero-subtitle text-center">Blockchain Voting System Management</p>
    </div>

    {% if not valid_chain %}
      <div class="alert alert-danger text-center">
        <i class="fas fa-exclamation-triangle"></i> 
        ‚ö† Blockchain Integrity Check Failed!
      </div>
    {% endif %}

    <div class="winner-banner">
      <i class="fas fa-trophy"></i> 
      üèÜ Winner: <strong>{{ winner }}</strong>
    </div>

    <div class="chart-container my-5">
      <canvas id="voteChart" height="100"></canvas>
    </div>

    <script>
      const ctx = document.getElementById('voteChart');

      const chartData = {
        labels: {{ labels|tojson }},
        datasets: [{
          label: "Vote Count",
          data: {{ counts|tojson }},
          backgroundColor: [
            '#FF9933',  // BJP
            '#138808',  // INC
            '#00BFFF',  // AAP
            '#2B65EC',  // BSP
            '#FF8C00',  // SS
            '#FF0000',  // CPI
            '#008080',  // NCP
            '#1E90FF'   // TMC
          ],
          borderColor: '#ffffff',
          borderWidth: 1
        }]
      };

      const chartOptions = {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } },
        animation: { duration: 1500, easing: 'easeOutBounce' }
      };

      new Chart(ctx, { type: 'bar', data: chartData, options: chartOptions });
    </script>

    <!-- Blockchain Ledger Section (Table View) -->
    <div class="ledger-container">
      <div class="ledger-header">
        <div class="ledger-icon">
          <i class="fas fa-link"></i>
        </div>
        <h2 class="ledger-title">üîó Blockchain Ledger</h2>
        <p class="ledger-subtitle">Immutable voting records secured by blockchain technology</p>
      </div>

      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          {% if active_validator %}
            <span class="badge bg-success me-2"><i class="fas fa-user-check"></i> Validator: {{ active_validator }}</span>
            <a href="{{ url_for('validator_logout') }}" class="btn btn-sm btn-outline-danger"><i class="fas fa-sign-out-alt"></i> Logout</a>
          {% else %}
            <a href="{{ url_for('validator_login') }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-user-shield"></i> Validator Login</a>
          {% endif %}
        </div>
        <div>
          {% if active_validator %}
            <form method="post" action="{{ url_for('validator_sign_latest') }}" class="d-inline me-2">
              <button class="btn btn-sm btn-success"><i class="fas fa-pen"></i> Sign Latest Block</button>
            </form>
            <form method="post" action="{{ url_for('validator_sign_all') }}" class="d-inline">
              <button class="btn btn-sm btn-outline-success"><i class="fas fa-check-double"></i> Sign All Blocks</button>
            </form>
          {% endif %}
        </div>
      </div>
      
      <div class="ledger-stats">
        <div class="stat-item">
          <span class="stat-number">{{ chain|length }}</span>
          <span class="stat-label">Total Blocks</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{{ chain|length - 1 }}</span>
          <span class="stat-label">Voting Transactions</span>
        </div>
        <div class="stat-item">
          <span class="stat-number">{% if valid_chain %}‚úÖ{% else %}‚ùå{% endif %}</span>
          <span class="stat-label">Chain Integrity</span>
        </div>
      </div>
      <div class="ledger-content">
        <div class="table-responsive">
          <table class="table table-striped table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th scope="col">Block #</th>
                <th scope="col">Timestamp</th>
                <th scope="col">Author</th>
                <th scope="col">Signatures</th>
                <th scope="col">Validity</th>
                <th scope="col">Data</th>
                <th scope="col">Hash</th>
                <th scope="col">Previous Hash</th>
              </tr>
            </thead>
            <tbody>
              {% for b in chain %}
              <tr>
                <td><strong>{{ b.index }}</strong></td>
                <td><span class="text-muted"><i class="fas fa-clock"></i> {{ b.timestamp }}</span></td>
                <td>
                  {% if 'author' in b and b.author %}
                    {% set auth = b.author %}
                    {% set vmeta = (validators_full | selectattr('id','equalto', auth) | list) %}
                    {% if vmeta and vmeta[0] %}
                      <span title="{{ vmeta[0].role }}">{{ auth | upper }}</span>
                    {% else %}
                      {{ auth | upper }}
                    {% endif %}
                  {% else %}-{% endif %}
                </td>
                <td>
                  {% set sigs = b.signatures if 'signatures' in b else [] %}
                  {% set req = b.required_signatures if 'required_signatures' in b else 1 %}
                  <span class="badge bg-info text-dark">{{ sigs|length }}/{{ req }}</span>
                  <div class="mt-1">
                    {% for v in validators_full %}
                      {% set has = (sigs | selectattr('validator', 'equalto', v.id) | list) | length > 0 %}
                      <span class="badge {% if has %}bg-success{% else %}bg-secondary{% endif %} me-1" title="{{ v.role }}">{{ v.id | upper }}</span>
                    {% endfor %}
                  </div>
                </td>
                <td>
                  {% set header = {'version': b.get('version','1'),'index': b.index,'timestamp': b.timestamp,'data': b.data,'previous_hash': b.previous_hash} %}
                  {% set assumed_valid = (sigs|length) >= req %}
                  <span class="badge {% if assumed_valid %}bg-success{% else %}bg-danger{% endif %}">
                    {% if assumed_valid %}Valid{% else %}Needs Signatures{% endif %}
                  </span>
                </td>
                <td>
                  {% if b.index == 0 %}
                    <span class="badge bg-warning text-dark">Genesis</span>
                    <span class="ms-2">{{ b.data['vote'] }}</span>
                  {% else %}
                    <div><small class="text-muted">Token:</small> <code class="hash-code">{{ b.data['anonymous_token'] }}</code></div>
                    {% if 'coin_id' in b.data %}
                      <div><small class="text-muted">Coin:</small> <code class="hash-code">{{ b.data['coin_id'] }}</code></div>
                    {% endif %}
                    <div><small class="text-muted">Vote:</small> <strong>{{ b.data['vote'] }}</strong></div>
                  {% endif %}
                </td>
                <td><code class="hash-code">{{ b.hash }}</code></td>
                <td><code class="hash-code">{{ b.previous_hash }}</code></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="text-center mt-4">
      <a href="{{ url_for('logout') }}" class="btn btn-danger btn-lg">
        <i class="fas fa-sign-out-alt"></i> Logout
      </a>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>